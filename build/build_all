#! /usr/bin/env bash

panic()
{
	echo "ERROR: $@"
	exit 1
}

program_dir=$(dirname "$0") || exit 1
jas_realpath="$program_dir/jas_realpath"
abs_program_dir=$("$jas_realpath" "$program_dir") || panic
build_program="$program_dir/build"

list_directory()
{
	local dir="$1"
	(cd "$dir" && find . -type f -printf "%M %010s %P\n" | sort -k3)
}

usage()
{
	echo "bad usage: $@"
	exit 2
}

verbose=0
build_dir=
crostini=0
enable=1
debug_level=0
strict=1

while getopts vb:cnd:sw option; do
	case "$option" in
	n)
		enable=0;;
	c)
		crostini=1;;
	b)
		build_dir="$OPTARG";;
	d)
		debug_level="$OPTARG";;
	v)
		verbose=$((verbose + 1));;
	w)
		strict=0;;
	s)
		strict=1;;
	*)
		usage "invalid option $option";;
	esac
done
shift $((OPTIND - 1))

if [ $# -ne 0 ]; then
	usage "unexpected command-line arguments"
fi

if [ "$debug_level" -ge 1 -a "$verbose" -eq 0 ]; then
	verbose=1
fi

if [ -z "$build_dir" ]; then
	build_dir="$abs_program_dir/../tmp_cmake"
fi

os=unknown
if [ -n "$RUNNER_OS" ]; then
	case "$RUNNER_OS" in
	MacOS|macOS)
		os=macos;;
	Linux|linux)
		os=linux;;
	Windows|windows)
		os=windows;;
	esac
fi

################################################################################

cat <<- EOF
================================================================================
Operating System: $os
================================================================================
EOF

global_options=()
if [ "$verbose" -ge 1 ]; then
	global_options+=(--verbose)
fi
if [ "$strict" -ge 1 ]; then
	global_options+=(--strict)
fi
if [ "$crostini" -ne 0 ]; then
	global_options+=(--crostini)
fi
global_options+=(--debug-level "$debug_level")
lsan_option=(--lsan)
asan_option=(--asan)
case "$os" in
macos)
	lsan_option=()
	;;
windows)
	asan_option=()
	;;
esac

################################################################################

#if [ "$os" = windows ]; then
	cat <<- EOF
	================================================================================
	File System Mount Information
	================================================================================
	EOF
	mount || panic "mount failed"
#fi

################################################################################

for multithread in 0 1; do

	cat <<- EOF
	================================================================================
	BUILD: Static Library Debug Build Using jas_init (ASan, LSan, UBSan)
	(Multithread $multithread)
	================================================================================
	EOF
	base_dir="$build_dir/test_static_debug-$multithread"
	command=("$build_program")
	command+=("${global_options[@]}")
	command+=(--build-dir "$base_dir/build")
	command+=(--install-dir "$base_dir/install")
	command+=(--static)
	command+=(--debug)
	command+=(--ubsan)
	command+=("${asan_option[@]}")
	command+=("${lsan_option[@]}")
	command+=(--test)
	command+=(--install)
	command+=(--no-documentation)
	command+=(--use-jas-init)
	if [ "$multithread" -ne 0 ]; then
		command+=(--multithread)
	else
		command+=(--no-multithread)
	fi
	echo "RUNNING: ${command[@]}"
	if [ "$enable" -ne 0 ]; then
		"${command[@]}" || panic
		echo "build directory:"
		list_directory "$base_dir/build" || panic
		echo "install directory:"
		list_directory "$base_dir/install" || panic
	fi

done

################################################################################

for multithread in 0 1; do

	cat <<- EOF
	================================================================================
	BUILD: Static Library Debug Build (ASan, LSan, UBSan)
	(Multithread $multithread)
	================================================================================
	EOF
	base_dir="$build_dir/test_static_debug-$multithread"
	command=("$build_program")
	command+=("${global_options[@]}")
	command+=(--build-dir "$base_dir/build")
	command+=(--install-dir "$base_dir/install")
	command+=(--static)
	command+=(--debug)
	command+=(--ubsan)
	command+=("${asan_option[@]}")
	command+=("${lsan_option[@]}")
	command+=(--test)
	command+=(--install)
	command+=(--no-documentation)
	command+=(--no-use-jas-init)
	if [ "$multithread" -ne 0 ]; then
		command+=(--multithread)
	else
		command+=(--no-multithread)
	fi
	echo "RUNNING: ${command[@]}"
	if [ "$enable" -ne 0 ]; then
		"${command[@]}" || panic
		echo "build directory:"
		list_directory "$base_dir/build" || panic
		echo "install directory:"
		list_directory "$base_dir/install" || panic
	fi

done

################################################################################

cat <<- EOF
================================================================================
BUILD: Multi-Thread Static Library Debug Build (TSan, UBSan)
================================================================================
EOF
base_dir="$build_dir/test_static_debug_tsan"
command=("$build_program")
command+=("${global_options[@]}")
command+=(--build-dir "$base_dir/build")
command+=(--install-dir "$base_dir/install")
command+=(--prefer-pthread)
command+=(--static)
command+=(--debug)
command+=(--ubsan)
command+=(--tsan)
command+=(--test)
command+=(--install)
command+=(--no-documentation)
command+=(--multithread)
command+=(--no-use-jas-init)
echo "RUNNING: ${command[@]}"
if [ "$enable" -ne 0 ]; then
	"${command[@]}" || panic
	echo "build directory:"
	list_directory "$base_dir/build" || panic
	echo "install directory:"
	list_directory "$base_dir/install" || panic
fi

################################################################################

for multithread in 0 1; do

	cat <<- EOF
	================================================================================
	BUILD: Shared Library Release Build
	(Multithread $multithread)
	================================================================================
	EOF
	base_dir="$build_dir/shared_release-$multithread"
	command=("$build_program")
	command+=("${global_options[@]}")
	command+=(--build-dir "$base_dir/build")
	command+=(--install-dir "$base_dir/install")
	command+=(--shared)
	command+=(--release)
	command+=(--documentation)
	command+=(--test)
	command+=(--install)
	command+=(--no-use-jas-init)
	if [ "$multithread" -ne 0 ]; then
		command+=(--multithread)
	else
		command+=(--no-multithread)
	fi
	echo "RUNNING: ${command[@]}"
	if [ "$enable" -ne 0 ]; then
		"${command[@]}" || panic
		echo "build directory:"
		list_directory "$base_dir/build" || panic
		echo "install directory:"
		list_directory "$base_dir/install" || panic
	fi

done

################################################################################

for multithread in 0 1; do

	cat <<- EOF
	================================================================================
	BUILD: Static Library Release Build
	(Multithread $multithread)
	================================================================================
	EOF
	base_dir="$build_dir/static_release-$multithread"
	command=("$build_program")
	command+=("${global_options[@]}")
	command+=(--build-dir "$base_dir/build")
	command+=(--install-dir "$base_dir/install")
	command+=(--static)
	command+=(--release)
	command+=(--documentation)
	command+=(--test)
	command+=(--install)
	if [ "$multithread" -ne 0 ]; then
		command+=(--multithread)
	else
		command+=(--no-multithread)
	fi
	echo "RUNNING: ${command[@]}"
	if [ "$enable" -ne 0 ]; then
		"${command[@]}" || panic
		echo "build directory:"
		list_directory "$base_dir/build" || panic
		echo "install directory:"
		list_directory "$base_dir/install" || panic
	fi

done

################################################################################
